---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "##",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# spEcula <img src="man/figures/logo.png" align="right" height="140"/>

<!-- badges: start -->
<!-- badges: end -->

The goal of **spEcula** is to make it easier to use R for spatial prediction based on *spatial dependence*, *spatial stratification heterogeneity* and *geographical configuration similarity*, and spatial statistical inference based on **spatial relationships** (the **three laws of geography**).

## Installation

You can install the development version of `spEcula` like so:

``` r
# install.packages("devtools")
devtools::install_github("SpatLyu/spEcula",build_vignettes = T,dep = T)
```

## Example

### Geographically Optimal Similarity (GOS) model

  `geosimilarity` package has achieved `gos` model,but when data is larger,`geosimilarity` may be slow. I develop the parallelized `gos` model in `spEcula`,which can change the `cores` argument in `gos()` and `bestkappa` function to parallel computation.

```{r example_gos}
library(spEcula)
data(zn)
data(grid)

zn$Zn = log(zn$Zn)
tictoc::tic()
g1 = gos(Zn ~ Slope + Water + NDVI  + SOC + pH + Road + Mine,
         data = zn, newdata = grid, kappa = 0.08,cores = 6)
tictoc::toc()
g1$pred = exp(g1$pred)
grid$pred = g1$pred
grid$uc99 = g1$`uncertainty99`
g1
```

```{r fig.width=9.5,fig.height=3.5}
library(ggplot2)
library(cowplot)
library(viridis)

f1 = ggplot(grid, aes(x = Lon, y = Lat, fill = pred)) +
  geom_tile() +
  scale_fill_viridis(option="magma", direction = -1) + 
  coord_equal() +
  labs(fill='Prediction') +
  theme_bw() 
f2 = ggplot(grid, aes(x = Lon, y = Lat, fill = uc99)) +
  geom_tile() +
  scale_fill_viridis(option="mako", direction = -1) + 
  coord_equal() +
  labs(fill=bquote(Uncertainty~(zeta==0.99))) +
  theme_bw() 

plot_grid(f1,f2,nrow = 1,label_fontfamily = 'serif',
          labels = paste0('(',letters[1:2],')'),
          label_fontface = 'plain',label_size = 10,
          hjust = -1.5,align = 'hv')  -> p
p
```

### Spatially-aware Self-Organizing Maps(GeoSOM) model

```{r example_geosom}
data(pmc)

set.seed(20220724)
tictoc::tic()
geosom_bestparam(data = pmc, 
                 coords = c("centroidx","centroidy"),
                 wt = c(seq(0.1,1,by = 0.1),2:5),
                 xdim = 4:10, ydim = 4:10,cores = 6) -> g_bestparam
tictoc::toc()
```

build geosom model

```{r Build-and-assess-geosom-model}
g = geosom(data = pmc, coords = c("centroidx","centroidy"), wt = .9,
           grid = geosomgrid(4,4,topo = "rectangular",
                             neighbourhood.fct = "gaussian"))
```

```{r}
g_superclass = geosom_superclass(g,6,method = 'pam')
g_superclass
```

```{r}
g_label = geosom_clusterlabel(g,g_superclass)
g_label
```

```{r fig.width=7.5, fig.height=5}
library(sf)
library(dplyr)

pmc %>% 
  mutate(zone = as.factor(g_label)) %>% 
  st_as_sf(coords = c("centroidx","centroidy")) %>% 
  ggplot() +
  geom_sf(aes(col = zone),size = 1.25,shape = 17) +
  scale_color_discrete(type = 'viridis') +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())
```

### Geographic detectors(geodetector) model

```{r example_gd}
data(NTDs)

ssh.test(incidence ~ watershed + elevation + soiltype,
         data = NTDs,type = 'factor')
```

